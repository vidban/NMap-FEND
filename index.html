<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style>
	#container {
		display: flex;
		flex-wrap: wrap;
	}
	input {
		width: 100vw;
		height: 20px;
	}
	table {
		margin-top: 5px;
		border: 2px solid black;
		z-index: 1;
	}

	.listview {
		height: 40px;
		background-color: #cccccc;
		text-align: center;
		vertical-align: middle;
		display: block;
		cursor: pointer;
	}

	.selected {
		background-color: #0d0d0d !important;
		color: white;
	}

	.listview:hover {
		background-color: #e6e6e6;
	}
	#map {
		position: absolute;
		margin-left: -260px;
		margin-top: 5px;
		width: 100vw;
		height: 100vw;
	}

	</style>
</head>
<body>
	<div id="container">
		<input type="text" placeholder="  Choose a place" data-bind="value: filter, valueUpdate: 'afterkeydown'">
		<table>
			<tbody data-bind="template: {name: 'list', foreach: filteredItems}">
			</tbody>
			<script id="list" type="text/html">
				<tr class="listview" data-bind="css: {'selected': num === $parent.currentSelected()}, click: function() { $parent.selectItem($parent, $data); $parent.filteredPin();}">
					<td><img data-bind="attr: {src: iconimage}"></td>
					<td data-bind="text: name"></td>
				</tr>
			</script>
		</table>
		<div id="map"></div>		
	</div>
</body>
<script src= "knockout-3.4.0.js"></script>
<script src = "jquery-1.10.2.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBUxuLeByYwf76lHdvL2QUXTMj7VJwrTMM&libraries=places&callback=initialize"
        async defer></script>
<script>


var map = ko.observable();
var infowindow;
var placeArray = ko.observableArray();
var MARKER_PATH = 'https://maps.gstatic.com/intl/en_us/mapfiles/marker_green';
var marker = ko.observableArray();


// create a map and setup markers for desired establishment

function initialize() {
	var loc = new google.maps.LatLng(37.383977, -122.081295);

	map = new google.maps.Map(document.getElementById('map'), {
		center: loc,
		zoom: 15
	});

	infowindow = new google.maps.InfoWindow();

	var service  = new google.maps.places.PlacesService(map);
	service.nearbySearch({
		location: loc,
		radius: 1000,
		types: ['school']
	}, callback);
}

function callback(results, status) {
	if (status === google.maps.places.PlacesServiceStatus.OK) {
    	for (var i = 0; i < results.length; i++) {
      		createMarker(results[i], i);
	    }
	}	
}

function createMarker(place, i) {
	var markerLetter = String.fromCharCode('A'.charCodeAt(0) + i);
   	var markerIcon = MARKER_PATH + markerLetter + '.png';
   	var markerLabel = place.name;

	marker[i] = new google.maps.Marker({
		map: map,
	    position: place.geometry.location,
	    animation: google.maps.Animation.DROP,
	    icon: markerIcon,
	    visible: false,
	    name: markerLabel
	});

	google.maps.event.addListener(marker[i], 'click', function() {
		map.panTo(this.position);
	    infowindow.setContent(markerLabel);
	    infowindow.open(map, this);
	});

	// populate arrays with results of google placesearch
   	placeArray.push({"num": i,"name": place.name, "iconimage":markerIcon, "placeResult":place}); 
   	marker.push(marker[i]);	

}

var placeViewModel = {
	names: placeArray,
	markers: marker,
	currentSelected: ko.observable(),
	selectItem: function(that, ind){
		that.currentSelected(ind.num);
		that.filteredPin(ind.name);
	},
	filter: ko.observable(""),
	filteredPin: ko.observable("")
};

// filters list and markers based on search
placeViewModel.filteredItems = ko.computed(function() {
		var filter = this.filter().toLowerCase();
		if (!filter){
			for (var k in this.markers()){
				this.markers()[k].visible = true;
			}
			return this.names();
		} else {
			pinresult = ko.utils.arrayFilter(this.markers(), function(pin) {
				var matches = pin.name.toLowerCase().indexOf(filter) >= 0;
				pin.setVisible(matches);
			})
			return ko.utils.arrayFilter(this.names(), function(item) {
				return item.name.toLowerCase().indexOf(filter) !== -1;
			});
		}
}, placeViewModel);

// triggers click for associated marker on menu click
placeViewModel.selectedPin = ko.computed(function() {
	var filteredPin = this.filteredPin();
	for (var k in this.markers()){
		if (this.markers()[k].name === filteredPin){
			google.maps.event.trigger(this.markers()[k], 'click');
		}
	}
}, placeViewModel);

ko.applyBindings(placeViewModel);
	
</script>
</html>